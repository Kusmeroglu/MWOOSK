<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>MWOOSK v.01a -- Layout Test</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <script src="http://code.jquery.com/jquery-1.8.2.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/ui/1.9.0/jquery-ui.js" type="text/javascript"></script>
    <script src="http://d3js.org/d3.v2.js" type="text/javascript"></script>
    <script src="js/weightchart.js" type="text/javascript"></script>
    <script src="js/rosegraph.js"></script>

    <link href="http://code.jquery.com/ui/1.9.0/themes/base/jquery-ui.css" rel="stylesheet" media="screen" />
    <link href="font/stylesheet.css" rel="stylesheet" media="screen" />
    <link href='http://fonts.googleapis.com/css?family=Aldrich' rel='stylesheet' type='text/css'>
	<link href="style2.css" rel="stylesheet" media="screen" />
	
	
	<script type="text/javascript">
        $(function () {

            // Generate the pull downs
            $.get('data/mechs.xml', function (xml) {
                $(xml).find("class").each(function () {
                    $("#mechClass").append($("<option></option>").attr("value",$(this).attr("type")).text($(this).attr("type")));
					$("#mechClassDiv").append($("<div class='selectItem' id='"+$(this).attr("type")+"'>"+$(this).attr("type")+"</div>"));
                });
				$("#mechClassDiv").children(".selectItem").click(function() {
					var selectItem = $(this).attr('id');
					$($(this).parent()).find("select").attr("value", selectItem);
					$($(this).parent()).find("select").change();
					$(this).parent().removeClass("active");
					$(this).siblings(".selectItem").hide();
					$(this).siblings("#classBlank").hide();
				});
				
            });

            // make the secondary pull down go
            $("#mechClass").on("change", function (event) {
                var selectedClass = $("#mechClass").val();
                $("#mechChassis").empty().append($("<option></option>").attr("value", "0").text("Select Mech Chassis..."));
				$("#mechChassisDiv").empty().append($("<div class='hide'><select id='mechChassis'><option value='0'>Select mech Chasis...</option></select></div><div class='selectBlank' id='chassisBlank'>Select mech Chassis...</div>"));
				$("#mechVariant").empty().append($("<option></option>").attr("value", "0").text("Select Mech Variant..."));
				$("#mechVariantDiv").empty().append($("<div class='hide'><select id='mechVariant'><option value='0'>Select mech Variant...</option></select></div><div class='selectBlank' id='variantBlank'>Select mech Variant...</div>"));
                $.get('data/mechs.xml', function (xml) {
                    $(xml).find('class[type="' + selectedClass + '"] > mech').each(function () {
                        $("#mechChassis").append($("<option></option>").attr("value", $(this).attr("type")).text($(this).attr("type")));
						$("#mechChassisDiv").append($("<div class='selectItem' id='"+$(this).attr("type")+"'>"+$(this).attr("type")+"</div>"));
                    });
                });
				
				$("#mechChassisDiv").children(".selectItem").click(function() {
					var selectItem = $(this).attr('id');
					$("#mechChassis").attr("value", selectItem);
					$("#mechChassis").change();
					$(this).parent().removeClass("active");
					$(this).siblings(".selectItem").hide();
					$(this).siblings("#chassisBlank").hide();
				});
				
			});

            // make the tertiary pull down go
            $("#mechChassis").on("change", function (event) {
                var selectedClass = $("#mechClass").val();
                $("#mechVariant").empty().append($("<option></option>").attr("value", "0").text("Select Mech Variant..."));
				$("#mechVariantDiv").empty().append($("<div class='selectBlank' id='variantBlank'>Select mech Variant...</div>"));
                $.get('data/mechs.xml', function (xml) {
                    $(xml).find('class[type="' + selectedClass + '"] > mech > variant').each(function () {
                        $("#mechVariant").append($("<option></option>").attr("value", $(this).attr("name")).text($(this).attr("name")));
						$("#mechVariantDiv").append($("<div class='selectItem' id='"+$(this).attr("type")+"'>"+$(this).attr("type")+"</div>"));
                    });
                });
				
				$("#mechVariantDiv").children(".selectItem").click(function() {
					var selectItem = $(this).attr('id');
					$($(this).parent()).find("select").attr("value", selectItem);
					$($(this).parent()).find("select").change();
					$(this).parent().removeClass("active");
					$(this).siblings(".selectItem").hide();
					$(this).siblings("#variantBlank").hide();
				});
				
			});
			
			// making the fake select boxes work
			$("#mechClassDiv").click(function() {
					$(this).children('.selectItem').show();
					$(this).children('#classBlank').show();
					$(this).addClass('active');
			});	
			$("#mechChassisDiv").click(function() {
					$(this).children('.selectItem').show();
					$(this).children('#chassisBlank').show();
					$(this).parent().addClass('active');
				});
			$("#mechVariantDiv").click(function() {
					$(this).children('.selectItem').show();
					$(this).children('#variantBlank').show();
					$(this).parent().addClass('active');
			});
			
			$(document).mouseup(function (e){
					var container = $(".selectBox");
					if (container.has(e.target).length === 0)
					{
						container.children(".selectItem").hide();
					}
				});				
			
					
            // save variant info off
            var currentVariant = {};

            $("#mechVariant").on("change", function (event){
                var selectedVariant = $("#mechVariant").val();
                var selectedMech = $("#mechChassis").val();
                currentVariant = {};
				currentVariant.limbs = {};
                currentVariant.name = selectedVariant;
                $.get('data/mechs.xml', function (xml) {
                    $(xml).find('mech[type="' + selectedMech + '"]').each(function () {
                        currentVariant.maxWeight = Number($(this).attr("tonnage"));
                        currentVariant.currentWeight = currentVariant.chassisWeight = Number($(this).attr("chassis"));
                    });
                    $(xml).find('variant[name="' + selectedVariant + '"] > limbs > limb').each(function () {
                        var limbname = $(this).attr("name");
                        currentVariant.limbs[limbname] = {};
                        $(this).find('hardpoint').each(function(){
                            var type = $(this).attr('type');
                            if ( currentVariant.limbs[limbname][type] ){
                                currentVariant.limbs[limbname][type] += 1;
                            } else {
                                currentVariant.limbs[limbname][type] = 1;
                            }
                        });
                    });
					$.each(currentVariant.limbs, function(index, value) { 
						var currentPiece = index;
						var hardpoints = value;
						$.each(hardpoints, function(i2, v2) {
							$("#" + currentPiece + "Description").append("<p>" + i2 + ": " + v2 + "</p>");
						});
						$("#" + currentPiece + "Description").append('<div class = "slider" id = "' + currentPiece + 'ArmorSlider"></div>');
					});
	
                });
				$("#mechBay").fadeIn('fast', function() {
					$("#itemList").fadeIn('fast');
                    createChart("#weightChart", currentVariant.maxWeight, currentVariant.chassisWeight, currentVariant.currentWeight);
                    createRoseGraph("#roseChart", "-N/A-");
					$( ".slider" ).slider({
	            		value:1,
		    	        min: 0,
        			    max: 45,
            			step: 1
					});
				});
            });

	        // Generate the item list
            $.get('data/items.xml', function (xml) {
                $(xml).find("weapons > item").each(function () {
                    $("#itemList").append($("<div></div>")
                            .attr("class", "item " + $(this).attr("type"))
                            .attr("alt", $(this).attr("type"))
                            .attr("title", $(this).attr("tons"))
                            // store all the weapon information in this div
                            .data({
                                type:$(this).attr("type"),
                                damage:$(this).attr("damage"),
                                heat:$(this).attr("heat"),
                                cooldown:$(this).attr("cooldown"),
                                range:$(this).attr("range"),
                                maxrange:$(this).attr("maxrange"),
                                slots:$(this).attr("slots"),
                                tons:$(this).attr("tons"),
                                dpsmax:$(this).attr("dpsmax"),
                                ammoper:$(this).attr("ammoper"),
                                hps:$(this).attr("hps"),
                                ehs:$(this).attr("ehs"),
                                name:$(this).text(),
                                rosechartdata:[
                                    { name:"Damage",   value:$(this).attr("damage")},
                                    { name:"Heat",     value:$(this).attr("heat")},
                                    { name:"HPS",      value:(Number($(this).attr("heat")) == 0)?"0":(Number($(this).attr("damage"))/Number($(this).attr("heat"))).toFixed(2)},
                                    { name:"Weight",   value:$(this).attr("tons")},
                                    { name:"Slots",    value:$(this).attr("slots")},
                                    { name:"Cooldown", value:$(this).attr("cooldown")},
                                    { name:"DPS",      value:$(this).attr("dpsmax")},
                                    //{ name:"Ammo/Ton", value:$(this).attr("ammoper")?$(this).attr("ammoper"):0},
                                    { name:"Range",    value:$(this).attr("maxrange")}
                                ]
                            })
                            .hover(
                                function(){
                                    updateRoseChartData($(this).data("rosechartdata"), $(this).data("name"));
                                },
                                function(){
                                    resetRoseChartData("-N/A-");
                                })
                            .text($(this).text()));
                });
                $("#itemList div").draggable({
                    revert: "invalid",
                    helper: 'clone',
                    appendTo: 'body'});
            });

            // Make the sections droppable
            $(".area").droppable({
                // use the same check for the accept attribute so we can show valid targets
                accept:function (ui) {
                    if (checkLimb(this, ui.attr("alt")) && checkWeight(Number(ui.attr("title")))) {
                        return true;
                    }
                    return false;
                },
                activeClass:"valid",
                drop:function (event, ui) {
                    if (checkLimb(this, $(ui.helper).attr("alt")) && checkWeight(Number($(ui.helper).attr("title")))) {
                        addItem($(ui.draggable).clone(), this);
                        addWeight(Number($(ui.helper).attr("title")));
                    }
                }

            });
			
			$("#mechBay div div a").live("click", function () {
				$(this).parent().remove();
                addWeight(0 - Number($(this).parent().attr("title")));
			})
			
	
            function addItem( $item, $target ) {
                $item.fadeOut(function() {
                    $item
                        .clone()
						.append('<a href = "#">X</a>')
                        .appendTo( $target )
                        .fadeIn();
                });
            }

            function checkLimb(limb, typeAdded)
			{
				var valid = false;
                var limbname = limb.id;
                //bail if no variant selected -- should we force people to pick one first?
                if (! currentVariant.limbs.hasOwnProperty(limbname) ){
                    return valid;
                }

				var max = currentVariant.limbs[limbname][typeAdded] ? currentVariant.limbs[limbname][typeAdded] : 0;
				if (max == 0) return valid;
				if ( $(limb).find("."+typeAdded).length < max )
				{
					valid = true;
				}
				return valid;
			}

            function checkWeight(weight){
                if ( currentVariant && weight ){
                    return (currentVariant.currentWeight + weight) <= currentVariant.maxWeight;
                }
                return false;
            }

            function addWeight(weight){
                if ( currentVariant && weight != undefined ){
                    currentVariant.currentWeight += weight;
                    updateChart(currentVariant.maxWeight, currentVariant.chassisWeight, currentVariant.currentWeight);
                }
            }
		
		});
    </script>
</head>
<body>
<div id="pageWrap">
	<header>
		<div id="chassisBar">
			<div class="selectBox" id="mechClassDiv">
				<div class="hide">
					<select id="mechClass">
						<option value="0">Select mech Class...</option>
					</select>
				</div>
				<div class="selectBlank" id="classBlank">Select mech Class...</div>
			</div>
			<div class="selectBox" id="mechChassisDiv">
				<div class="hide">
					<select id="mechChassis">
						<option value="0">Select mech Chasis...</option>
					</select>
				</div>
				<div class="selectBlank" id="chassisBlank">Select mech Chassis...</div>
			</div>
			<div class="selectBox" id="mechVariantDiv">
				<div class="hide">
					<select id="mechVariant">
						<option value="0">Select mech Variant...</option>
					</select>
				</div>
				<div class="selectBlank" id="variantBlank">Select mech Variant...</div>
			</div>
			<div class="clear"></div>
		</div>
		<div id="userInfo"></div>
		<div class="clear"></div>
	</header>
	<div id="mechBay">
		<div id="mechContainerWrap">
			<div id="mechContainer">
				<div id="head"></div>
				<div id="rightArm"></div>
				<div id="rightTorso"></div>
				<div id="centerTorso"></div>
				<div id="leftTorso"></div>
				<div id="leftArm"></div>
				<div id="rightLeg"></div>
				<div id="leftLeg"></div>
			</div>
			<div id="componentWrap">
				<div id="focusLine"></div>
				<div id="componentDetail"></div>
			</div>
		</div>
	</div>
	<div id="tabWrap">
			<div class="tabWrapper">
				<div class="tab" id="armamentTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="utilityTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="upgradeTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="statisticsTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="commentsTab"></div>
			</div>
			<!-- <div class="tabWrapper">
				<div class="tab" id="upgradesTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="modulesTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="statsTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="weaponGroupTab"></div>
			</div><div class="tabWrapper">
				<div class="tab" id="pilotSkillsTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="commentsTab"></div>
			</div> -->
			<div class="clear"></div>
		</div>
	<div id="itemWrap">
		<div id="detailContainerWrap">
			<div id="detailContainer">
				<div id="ballistics"></div>
				<div id="energy"></div>
				<div id="missles"></div>
				<div id="utilities"></div>
				<div id="engines"></div>
				<div id="upgrades"></div>
				<div id="modules"></div>
				<div id="stats"></div>
				<div id="weaponGroups"></div>
				<div id="pilotSkills"></div>
			</div>
		</div>
		
	</div>
	<div class="clear"></div>
	
	<footer>
	<div id="tonnageWrap">
		<div id="tonnage"></div>
	</div>
	<div id="speedWrap">
		<div id="speed"></div>
	</div>
	<div id="commentsWrap">
		<div id="comments"></div>
	</div>
	<div class="clear"></div>
	</footer>
	</div>

</body>
</html>