<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>MWOOSK v.01a -- Layout Test</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <script src="http://code.jquery.com/jquery-1.8.2.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/ui/1.9.0/jquery-ui.js" type="text/javascript"></script>
    <script src="http://d3js.org/d3.v2.js" type="text/javascript"></script>
    <script src="js/weightchart.js" type="text/javascript"></script>
    <script src="js/rosegraph.js"></script>

    <link href="http://code.jquery.com/ui/1.9.0/themes/base/jquery-ui.css" rel="stylesheet" media="screen" />
    <link href="font/stylesheet.css" rel="stylesheet" media="screen" />
    <link href='http://fonts.googleapis.com/css?family=Aldrich' rel='stylesheet' type='text/css'>
	<link href="style2.css" rel="stylesheet" media="screen" />
	
	
	<script type="text/javascript">
    var mechObj;
    var mechXML;
    var draggableOptions = {
        revert: "invalid",
        helper: function(){
            var x = $(this).clone(true, true);
            $(this).draggable(draggableOptions); //reset draggable?
            return x;
        },
        appendTo: 'body'
    };

    $(function () {
        // Generate the item list
        $.get('data/items.xml', function (xml) {
            $(xml).find("weapons > item").each(function () {
                $("#itemList").append($("<div></div>")
                        .attr("class", "item " + $(this).attr("type") + " " + $(this).attr("id"))
                        .attr("alt", $(this).attr("type"))
                        .attr("name", $(this).attr("slots"))
                    //    .attr("id", $(this).attr("id"))
                    // store all the weapon information in this div
                        .data({
                            id:$(this).attr("id"),
                            type:$(this).attr("type"),
                            damage:$(this).attr("damage"),
                            heat:$(this).attr("heat"),
                            cooldown:$(this).attr("cooldown"),
                            range:$(this).attr("range"),
                            maxrange:$(this).attr("maxrange"),
                            slots:$(this).attr("slots"),
                            tons:$(this).attr("tons"),
                            dpsmax:$(this).attr("dpsmax"),
                            ammoper:$(this).attr("ammoper"),
                            hps:$(this).attr("hps"),
                            ehs:$(this).attr("ehs"),
                            name:$(this).text(),
                            itemObj: new item($(this).attr("id"), $(this).text(), $(this).attr("slots"), $(this).attr("tons"), $(this).attr("type")),
                            rosechartdata:[
                                { name:"Damage",   value:$(this).attr("damage")},
                                { name:"Heat",     value:$(this).attr("heat")},
                                { name:"HPS",      value:(Number($(this).attr("heat")) == 0)?"0":(Number($(this).attr("damage"))/Number($(this).attr("heat"))).toFixed(2)},
                                { name:"Weight",   value:$(this).attr("tons")},
                                { name:"Slots",    value:$(this).attr("slots")},
                                { name:"Cooldown", value:$(this).attr("cooldown")},
                                { name:"DPS",      value:$(this).attr("dpsmax")},
                                //{ name:"Ammo/Ton", value:$(this).attr("ammoper")?$(this).attr("ammoper"):0},
                                { name:"Range",    value:$(this).attr("maxrange")}
                            ]
                        })
                        .hover(
                        function(){
                            updateRoseChartData($(this).data("rosechartdata"), $(this).data("name"));
                        },
                        function(){
                            resetRoseChartData("-N/A-");
                        })
                        .text($(this).text()));
            });
            $("#itemList div").draggable(draggableOptions);
        });

        // making the fake select boxes work
        $("#mechClassDiv").click(function() {
            $(this).children('.selectItem').show();
            $(this).children('#classBlank').show();
            $(this).addClass('active');
        });
        $("#mechChassisDiv").click(function() {
            $(this).children('.selectItem').show();
            $(this).children('#chassisBlank').show();
            $(this).parent().addClass('active');
        });
        $("#mechVariantDiv").click(function() {
            $(this).children('.selectItem').show();
            $(this).children('#variantBlank').show();
            $(this).parent().addClass('active');
        });

        $(document).mouseup(function (e){
            var container = $(".selectBox");
            if (container.has(e.target).length === 0)
            {
                container.children(".selectItem").hide();
            }
        });

        // load XML just the once.
        $.get('data/mechs.xml', function (xml){
            mechXML = $(xml);
            mechXML.find("class").each(function () {
                $("#mechClass").append($("<option></option>").attr("value",$(this).attr("type")).text($(this).attr("type")));
                $("#mechClassDiv").append($("<div class='selectItem' id='"+$(this).attr("type")+"'>"+$(this).attr("type")+"</div>"));
            });
            $("#mechClassDiv").children(".selectItem").click(function(event) {
                event.stopPropagation();
                var selectItem = $(this).attr('id');
                $($(this).parent()).find("select").attr("value", selectItem);
                $($(this).parent()).find("select").change();
                $(this).parent().removeClass("active");
                $(this).siblings(".selectItem").hide();
                $(this).siblings("#classBlank").hide();
            });

            // make the secondary pull down go
            $("#mechClass").on("change", function (event) {
                var selectedClass = $("#mechClass").val();
                $("#mechChassis").empty().append($("<option></option>").attr("value", "0").attr('id','chassisBlank').text("Select mech name..."));
                $("#mechChassisDiv .selectBlank, #mechChassisDiv .selectItem").remove();
                $("#mechChassisDiv").append($("<div class='selectBlank' id='chassisBlank'>Select mech Chassis...</div>"));
                $("#mechVariant").empty().append($("<option></option>").attr("value", "0").attr('id','variantBlank').text("Select Mech Variant..."));
                $("#mechVariantDiv .selectBlank, #mechVariantDiv .selectItem").remove();
                $("#mechVariantDiv").append($("<div class='selectBlank' id='variantBlank'>Select mech Variant...</div>"));
                mechXML.find('class[type="' + selectedClass + '"] > mech').each(function () {
                    $("#mechChassis").append($("<option></option>").attr("value", $(this).attr("type")).text($(this).attr("type")));
                    $("#mechChassisDiv").append($("<div class='selectItem' id='"+$(this).attr("type")+"'>"+$(this).attr("type")+"</div>"));
                });
                $("#mechChassisDiv").children(".selectItem").click(function(event) {
                    event.stopPropagation();
                    var selectItem = $(this).attr('id');
                    $("#mechChassis").attr("value", selectItem);
                    $("#mechChassis").change();
                    $(this).parent().removeClass("active");
                    $(this).siblings(".selectItem").hide();
                    $(this).siblings("#chassisBlank").hide();
                });
            });

            // make the tertiary pull down go
            $("#mechChassis").on("change", function (event) {
                var selectedChassis = $("#mechChassis").val();
                $("#mechVariant").empty().append($("<option></option>").attr("value", "0").attr('id','variantBlank').text("Select mech variant..."));
                $("#mechVariantDiv .selectBlank, #mechVariantDiv .selectItem").remove();
                $("#mechVariantDiv").append($("<div class='selectBlank' id='variantBlank'>Select mech Variant...</div>"));
                mechXML.find('class > mech[type="' + selectedChassis + '"] > variant').each(function () {
                    $("#mechVariant").append($("<option></option>").attr("value", $(this).attr("name")).text($(this).attr("name")));
                    $("#mechVariantDiv").append($("<div class='selectItem' id='"+$(this).attr("name")+"'>"+$(this).attr("name")+"</div>"));
                });
                $("#mechVariantDiv").children(".selectItem").click(function(event) {
                    event.stopPropagation();
                    var selectItem = $(this).attr('id');
                    $("#mechVariant").attr("value", selectItem);
                    $("#mechVariant").change();
                    $(this).parent().removeClass("active");
                    $(this).siblings(".selectItem").hide();
                    $(this).siblings("#variantBlank").hide();
                });
            });

            $("#mechVariant").on("change", function (event) {
                if ($("#mechVariant").val() == "0"){
                    return;
                }
                mechXML.find('mech[type="' + $("#mechChassis").val() + '"]').each(function () {
                    mechObj = new mech($("#mechChassis").val(), $("#mechVariant").val(), parseFloat($(this).attr("tonnage")));
                    mechObj.currentTons = mechObj.chassisTons = parseFloat($(this).attr("chassis"));
                });
                mechXML.find('mech[type="' + mechObj.chassis + '"] variant[name="' + mechObj.variant + '"] > limbs > limb').each(function () {
                    var limbObj = new limb($(this).attr("name"), $(this).attr("crits"), $(this).attr("armorFront"), $(this).attr("armorRear"), $(this).attr("maxArmor"));
                    setURLParameter(limbObj.limbName, "");
                    $(this).find('hardpoint').each(function(){
                        var hardPointObj = new hardPoint($(this).attr('type'));
                        limbObj.addHardPoint(hardPointObj);
                    });
                    mechObj.addLimb($(this).attr("name"), limbObj);
                });
                //To-do: loop through each limb, count hard points by type, add to description
                $("#mechBay").fadeIn('fast', function() {
                    $("#itemList").fadeIn('fast');
                    createChart("#weightChart", mechObj.maxTons, mechObj.chassisTons, mechObj.currentTons);
                    createRoseGraph("#roseChart", "-N/A-");
                    $( ".slider" ).slider({
                        value:1,
                        min: 0,
                        max: 45,
                        step: 1
                    });
                    //check for info in URLs
                    // have to wait until we have graphs created.
                    var urldata = getURLParamObject();
                    if (urldata.hasOwnProperty('variant')){
                        //To-do: loop through each limb, count hard points by type, add to description
                        ['leftArm', 'leftTorso','centerTorso','rightTorso','rightArm','leftLeg','rightLeg','head'].forEach(function(limb){
                            if (urldata.hasOwnProperty(limb)){
                                var rawitems = urldata[limb];
                                var limbelem = $('#'+limb);
                                var i = 0;
                                while(i < rawitems.length)
                                {
                                    var thisitemid = rawitems.substr(i, 2);
                                    var thisitemelem = $('#itemList .'+thisitemid);
                                    var itemObj = thisitemelem.data('itemObj');
                                    mechObj.addItemToLimb(limb, itemObj);
                                    thisitemelem
                                            .clone(true, true)
                                            .draggable( "destroy" )
                                            .append('<div class="close">X</div>')
                                            .appendTo(limbelem)
                                            .fadeIn();
                                    i += 2;
                                }
                            }
                        })
                    }

                });
            });

            //check for info in URLs
            var urldata = getURLParamObject();
            if (urldata.hasOwnProperty('variant')){
                var mechVariant = urldata['variant'];
                // we have data to load
                mechXML.find('mech variant[name="' + mechVariant + '"]').each(function () {
                    var mechClass = $(this).parents('class').attr('type').toString();
                    $("#mechClass").val(mechClass).change();
                    var mechChassis = $(this).parents('mech').attr('type').toString();
                    $("#mechChassis").val(mechChassis).change();
                });
                $("#mechVariant").val(mechVariant).change();
            }
        });

        $(".area").droppable({
            // use the same check for the accept attribute so we can show valid targets
            accept: function (ui) {
                var itemObj = ui.data('itemObj');
                return mechObj.limbs[this.id].testIfValid(itemObj);
            },
            activeClass: "valid",
            drop: function (event, ui) {
                var itemObj = $(ui.draggable).data('itemObj');
                mechObj.addItemToLimb(this.id, itemObj);
                addItem($(ui.draggable).clone(true, true), this);
            }
        });

        $("#mechBay div div .close").live("click", function () {
            var itemObj = $(this).parent().data('itemObj');
            mechObj.removeItemFromLimb($(this).parents('.area')[0].id, itemObj);
            $(this).parent().remove();
        });

        function addItem($item, $target) {
            $item.fadeOut(function () {
                $item
                        .clone(true, true)
                        .append('<div class="close">X</div>')
                        .appendTo($target)
                        .fadeIn();
            });
        }

    });
    </script>
</head>
<body>
<div id="pageWrap">
	<header>
		<div id="chassisBar">
			<div class="selectBox" id="mechClassDiv">
				<div class="hide">
					<select id="mechClass">
						<option value="0">Select mech Class...</option>
					</select>
				</div>
				<div class="selectBlank" id="classBlank">Select mech Class...</div>
			</div>
			<div class="selectBox" id="mechChassisDiv">
				<div class="hide">
					<select id="mechChassis">
						<option value="0">Select mech Chasis...</option>
					</select>
				</div>
				<div class="selectBlank" id="chassisBlank">Select mech Chassis...</div>
			</div>
			<div class="selectBox" id="mechVariantDiv">
				<div class="hide">
					<select id="mechVariant">
						<option value="0">Select mech Variant...</option>
					</select>
				</div>
				<div class="selectBlank" id="variantBlank">Select mech Variant...</div>
			</div>
			<div class="clear"></div>
		</div>
		<div id="userInfo"></div>
		<div class="clear"></div>
	</header>
	<div id="mechBay">
		<div id="mechContainerWrap">
			<div id="mechContainer">
				<div id="head"></div>
				<div id="rightArm"></div>
				<div id="rightTorso"></div>
				<div id="centerTorso"></div>
				<div id="leftTorso"></div>
				<div id="leftArm"></div>
				<div id="rightLeg"></div>
				<div id="leftLeg"></div>
			</div>
			<div id="componentWrap">
				<div id="focusLine"></div>
				<div id="componentDetail"></div>
			</div>
		</div>
	</div>
	<div id="tabWrap">
			<div class="tabWrapper">
				<div class="tab" id="armamentTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="utilityTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="pilotingTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="statisticsTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="commentsTab"></div>
			</div>
			<!-- <div class="tabWrapper">
				<div class="tab" id="upgradesTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="modulesTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="statsTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="weaponGroupTab"></div>
			</div><div class="tabWrapper">
				<div class="tab" id="pilotSkillsTab"></div>
			</div>
			<div class="tabWrapper">
				<div class="tab" id="commentsTab"></div>
			</div> -->
			<div class="clear"></div>
		</div>
	<div id="itemWrap">
		<div id="detailContainerWrap">
			<div id="detailContainer">
				<div id="ballistics">
                    <div id ="itemList" style="display:none"></div>
                    <div id="roseChart" style="width:220px;height:220px"></div>
				</div>
				<div id="energy"></div>
				<div id="missles"></div>
				<div id="utilities"></div>
				<div id="engines"></div>
				<div id="upgrades"></div>
				<div id="modules"></div>
				<div id="stats"></div>
				<div id="weaponGroups"></div>
				<div id="pilotSkills"></div>
			</div>
		</div>
		
	</div>
	<div class="clear"></div>
	
	<footer>
	<div id="tonnageWrap">
		<div id="tonnage">
            <div id ="weightChart" ></div>
		</div>
	</div>
	<div id="speedWrap">
		<div id="speed"></div>
	</div>
	<div id="commentsWrap">
		<div id="comments"></div>
	</div>
	<div class="clear"></div>
	</footer>
	</div>

</body>
</html>