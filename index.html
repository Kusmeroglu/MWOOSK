<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>MWOOSK v.01a</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <script src="http://code.jquery.com/jquery-1.8.2.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/ui/1.9.0/jquery-ui.js" type="text/javascript"></script>
    <script src="http://d3js.org/d3.v2.js" type="text/javascript"></script>
    <script src="js/weightchart.js" type="text/javascript"></script>

    <link href="http://code.jquery.com/ui/1.9.0/themes/base/jquery-ui.css" rel="stylesheet" media="screen" />
    <link href="font/stylesheet.css" rel="stylesheet" media="screen" />
    <link href='http://fonts.googleapis.com/css?family=Aldrich' rel='stylesheet' type='text/css'>
    <link href="style.css" rel="stylesheet" media="screen" />

    <script type="text/javascript">
        $(function () {

            // Generate the pull downs
            $.get('data/mechs.xml', function (xml) {
                $(xml).find("class").each(function () {
                    $("#mechClass").append($("<option></option>").attr("value",$(this).attr("type")).text($(this).attr("type")));
                });
            });

            // make the secondary pull down go
            $("#mechClass").on("change", function (event) {
                var selectedClass = $("#mechClass").val();
                $("#mechName").empty().append($("<option></option>").attr("value", "0").text("Select mech name..."));
                $.get('data/mechs.xml', function (xml) {
                    $(xml).find('class[type="' + selectedClass + '"] > mech').each(function () {
                        $("#mechName").append($("<option></option>").attr("value", $(this).attr("type")).text($(this).attr("type")));
                    });
                });
            });

            // make the tertiary pull down go
            $("#mechName").on("change", function (event) {
                var selectedClass = $("#mechClass").val();
                $("#mechVariant").empty().append($("<option></option>").attr("value", "0").text("Select mech variant..."));
                $.get('data/mechs.xml', function (xml) {
                    $(xml).find('class[type="' + selectedClass + '"] > mech > variant').each(function () {
                        $("#mechVariant").append($("<option></option>").attr("value", $(this).attr("name")).text($(this).attr("name")));
                    });
                });
            });


            // save variant info off
            var currentVariant = {};

            $("#mechVariant").on("change", function (event){
                var selectedVariant = $("#mechVariant").val();
                var selectedMech = $("#mechName").val();
                currentVariant = {};
				currentVariant.limbs = {};
                currentVariant.name = selectedVariant;
                $.get('data/mechs.xml', function (xml) {
                    $(xml).find('mech[type="' + selectedMech + '"]').each(function () {
                        currentVariant.maxWeight = Number($(this).attr("tonnage"));
                        currentVariant.currentWeight = currentVariant.chassisWeight = Number($(this).attr("chassis"));
                    });
                    $(xml).find('variant[name="' + selectedVariant + '"] > limbs > limb').each(function () {
                        var limbname = $(this).attr("name");
                        currentVariant.limbs[limbname] = {};
                        $(this).find('hardpoint').each(function(){
                            var type = $(this).attr('type');
                            if ( currentVariant.limbs[limbname][type] ){
                                currentVariant.limbs[limbname][type] += 1;
                            } else {
                                currentVariant.limbs[limbname][type] = 1;
                            }
                        });
                    });
					$.each(currentVariant.limbs, function(index, value) { 
						var currentPiece = index;
						var hardpoints = value;
						$.each(hardpoints, function(i2, v2) {
							$("#" + currentPiece + "Description").append("<p>" + i2 + ": " + v2 + "</p>");
						});
						$("#" + currentPiece + "Description").append('<div class = "slider" id = "' + currentPiece + 'ArmorSlider"></div>');
					});
	
                });
				$("#mechBay").fadeIn('fast', function() {
					$("#itemList").fadeIn('fast');
                    createChart("#weightChart", currentVariant.maxWeight, currentVariant.chassisWeight, currentVariant.currentWeight);
					$( ".slider" ).slider({
	            		value:1,
		    	        min: 0,
        			    max: 45,
            			step: 1
					});
				});
            });

	        // Generate the item list
            $.get('data/items.xml', function (xml) {
                $(xml).find("weapons > item").each(function () {
                    $("#itemList").append($("<div></div>")
                            .attr("class", $(this).attr("type"))
                            .attr("alt", $(this).attr("type"))
                            .attr("title", $(this).attr("tons"))
                            .text($(this).text()));
                });
                $("#itemList div").draggable({
                    revert: "invalid",
                    helper: 'clone',
                    appendTo: 'body'});
            });

            // Make the sections droppable
            $(".area").droppable({
                // use the same check for the accept attribute so we can show valid targets
                accept:function (ui) {
                    if (checkLimb(this, ui.attr("alt")) && checkWeight(Number(ui.attr("title")))) {
                        return true;
                    }
                    return false;
                },
                activeClass:"valid",
                drop:function (event, ui) {
                    if (checkLimb(this, $(ui.helper).attr("alt")) && checkWeight(Number($(ui.helper).attr("title")))) {
                        addItem($(ui.draggable).clone(), this);
                        addWeight(Number($(ui.helper).attr("title")));
                    }
                }

            });
			
			$("#mechBay div div a").live("click", function () {
				$(this).parent().remove();
                addWeight(0 - Number($(this).parent().attr("title")));
			})
			
	
            function addItem( $item, $target ) {
                $item.fadeOut(function() {
                    $item
                        .clone()
						.append('<a href = "#">X</a>')
                        .appendTo( $target )
                        .fadeIn();
                });
            }

            function checkLimb(limb, typeAdded)
			{
				var valid = false;
                var limbname = limb.id;
                //bail if no variant selected -- should we force people to pick one first?
                if (! currentVariant.limbs.hasOwnProperty(limbname) ){
                    return valid;
                }

				var max = currentVariant.limbs[limbname][typeAdded] ? currentVariant.limbs[limbname][typeAdded] : 0;
				if (max == 0) return valid;
				if ( $(limb).find("."+typeAdded).length < max )
				{
					valid = true;
				}
				return valid;
			}

            function checkWeight(weight){
                if ( currentVariant && weight ){
                    return (currentVariant.currentWeight + weight) <= currentVariant.maxWeight;
                }
                return false;
            }

            function addWeight(weight){
                if ( currentVariant && weight != undefined ){
                    currentVariant.currentWeight += weight;
                    updateChart(currentVariant.maxWeight, currentVariant.chassisWeight, currentVariant.currentWeight);
                }
            }

		});
    </script>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
    <div id ="topbar">
        <select id ="mechClass">
            <option value="0">Select mech class...</option>
        </select>
        <select id ="mechName">
            <option value="0">Select mech name...</option>
        </select>
        <select id ="mechVariant">
            <option value="0">Select mech varient...</option>
        </select>
    </div>
    <div id ="weightChart" ></div>
    <div id ="mechBay" style="display:none">
        <div class="area" id="head">
            <div class="descriptor" id="headDescription">Head
            </div>
        </div>
        <div class="area" id="leftTorso">
            <div class="descriptor" id="leftTorsoDescription">Left Torso
            </div>
        </div>
        <div class="area" id="rightTorso">
            <div class="descriptor" id="rightTorsoDescription">Right Torso
            </div>
        </div>
        <div class="area" id="leftArm">
            <div class="descriptor" id="leftArmDescription">Left Arm
            </div>
        </div>
        <div class="area" id="rightArm">
            <div class="descriptor" id="rightArmDescription">Right Arm
            </div>
        </div>
        <div class="area" id="centerTorso">
            <div class="descriptor" id="centerTorsoDescription">Center Torso
            </div>
        </div>
        <div class="area" id="leftLeg">
            <div class="descriptor" id="leftLegDescription">Left Leg
            </div>
        </div>
        <div class="area" id="rightLeg">
            <div class="descriptor" id="rightLegDescription">Right Leg
            </div>
        </div>
    </div>
    <div id ="itemList" style="display:none">
    </div>
</html>
